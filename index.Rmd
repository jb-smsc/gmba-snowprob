---
title: "GMBA MODIS SnowProb anomalies 2024"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
    theme: 
      version: 5
      bootswatch: morph
editor_options: 
  chunk_output_type: console
---

```{r setup}
library(flexdashboard)
library(dplyr)
library(stringr)
library(sf)
library(leaflet)
library(htmltools)
library(rmapshaper)
```


```{r data-prep}

tbl_annual <- readRDS(here::here("data/snowprob-02-clim20-annual.rds"))
sf_gmba <- read_sf(here::here("data-raw/GMBA_Inventory_v2.0_standard_basic/"))

sf_gmba2 <- ms_simplify(sf_gmba, keep = 0.2, keep_shapes = FALSE)

tbl_plot <- tbl_annual |> 
  filter(years == 2023, snowprob_clim20 >= 5) |>  
  mutate(anom = means - snowprob_clim20,
         anom_rel = (means - snowprob_clim20)/snowprob_clim20*100) |> 
  select(GMBA_V2_ID, snowprob_clim20, anom, anom_rel)

sf_plot <- sf_gmba2 |> 
  select(GMBA_V2_ID, MapName) |> 
  left_join(tbl_plot) |> 

  filter(!is.na(anom_rel)) %>% 
  mutate(xx_col = if_else(anom_rel > 150, 150, anom_rel) %>% as.integer) %>% 
  rename(Name = MapName, 
         Snowprob_2024_anomaly_rel = anom_rel,
         Snowprob_2024_anomaly_abs = anom,
         Snowprob_clim_2000_2020 = snowprob_clim20) %>% 
  mutate(labels = str_c(
    "<table>",
    "<tr><th style='text-align: left'>", Name, "</th></tr>",
    "<tr>", 
    "<td>", "Snow probability 2024 anomaly:", "</td>",
    "<td style='text-align: right; padding-left: 15px;'>", sprintf("%0.f %%", Snowprob_2024_anomaly_rel), "</td>",
    "</tr>",
    "<tr>", 
    "<td>", "Snow probability 2024 anomaly (absolute):", "</td>",
    "<td style='text-align: right; padding-left: 15px;'>", sprintf("%.0f d", Snowprob_2024_anomaly_abs), "</td>",
    "</tr>",
    "<tr>", 
    "<td>", "Snow probability average 2001-2020:", "</td>",
    "<td style='text-align: right; padding-left: 15px;'>", sprintf("%.0f d", Snowprob_clim_2000_2020), "</td>",
    "</tr>",
    "</table>"
  )) 

# pal <- colorNumeric("RdYlBu", domain = sf_plot$xx_col, reverse = F)
# pal2 <- colorNumeric("RdYlBu", domain = sf_plot$xx_col, reverse = T)

pal_pos <- colorRampPalette(colors = c("#ffffbf", "#2c7bb6"), space = "Lab")(150)
pal_neg <- colorRampPalette(colors = c("#d7191c", "#ffffbf"), space = "Lab")(100)

pal <- colorNumeric(palette = c(pal_neg, pal_pos), domain = c(-100, 150))
pal2 <- colorNumeric(palette = c(pal_neg, pal_pos), domain = c(-100, 150), reverse = T)

```



# Map

## Column 

### Map

```{r map}
leaflet(sf_plot) |> 
  addProviderTiles("CartoDB.Positron", group = "CartoDB") |> 
  addProviderTiles("Esri.WorldTopoMap", group = "Topomap") |>  
  addProviderTiles("Esri.WorldImagery", group = "WorldImagery") |>  
  addPolygons(
    data = sf_plot,
    fillColor = ~pal(xx_col),
    fillOpacity = 1,
    color = ~pal(xx_col),
    opacity = 1,
    # stroke = FALSE,
    weight = 0,
    # group = "ERA5-Land",
    highlightOptions = highlightOptions(
      color = "black",
      weight = 2,
      # dashArray = ""
      bringToFront = FALSE
    ),
    label = lapply(sf_plot$labels, htmltools::HTML),
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "12px",
      offset = c(20, 20),
      direction = "auto")
  ) |> 
  addLayersControl(
    baseGroups = c("CartoDB", "Topomap", "WorldImagery"),
    # overlayGroups = c("ERA5-Land", "In-situ"),
    position = "topright"
  ) |> 
  addLegend(pal = pal2, values = c(-100, 150), opacity = 1, 
            title = "Snow Probability</br>2024 anomaly",
            position = "bottomright",
            labFormat = labelFormat(transform = \(x) sort(x, decreasing = TRUE),
                                    suffix = " %"))

  
```


# About

## Column 

### Notes

Polygons with less than 5 days of snow cover per year (climatological average) were removed.

Positive anomalies capped to a maximum of 150%. 


### Version history

v0.1 (2025-01-22)

- first online version

## Column 

### About


This is a contribution to the IACS joint body on mountain snow cover, working group 2.

Snow probability is the ratio of the number of snow days to the number of clear-sky days. Here the snow probability is computed by hydrological year and expressed in days per year. The hydrological years begin on Sep 01 (northern hemisphere) and Mar 01 (southern hemisphere).

Maps show anomalies of the 2023-2024 season relative to the climatology 2001-2020.

GBMA polygons have been simplified by a factor of 5 for simpler and faster online accessibility.

MODIS data processing by S. Gascoin ([sgascoin](https://github.com/sgascoin)), dashboard by M. Matiu ([mitmat](https://github.com/mitmat))




### References 

Snethlage, M.A., Geschke, J., Spehn, E.M., Ranipeta, A., Yoccoz, N.G., Körner, Ch., Jetz, W., Fischer, M. & Urbach, D. A hierarchical inventory of the world’s mountains for global comparative mountain science. Nature Scientific Data. https://doi.org/10.1038/s41597-022-01256-y (2022).
Dataset

Snethlage, M.A., Geschke, J., Spehn, E.M., Ranipeta, A., Yoccoz, N.G., Körner, Ch., Jetz, W., Fischer, M. & Urbach, D. GMBA Mountain Inventory v2. GMBA-EarthEnv. https://doi.org/10.48601/earthenv-t9k2-1407 (2022).




